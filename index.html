<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OneDrive Picker v8 - Merged</title>
  <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.19.0/js/msal-browser.min.js"></script>
  <script type="text/javascript">
// ===== AUTH.JS MERGED =====
function combine(...paths) {
  return paths.map(p => p.replace(/^\/+/, '').replace(/\/+$/, '')).join('/').replace(/\/g, '/');
}
const msalParams = {
  auth: {
    authority: "https://login.microsoftonline.com/common",
    clientId: "7a4d1385-9b7c-47d3-8669-1abf187d7483",
    redirectUri: "https://michal-juppe.github.io/picker_test/"
  }
};
const app = new msal.PublicClientApplication(msalParams);
async function getToken(command) {
  let authParams = null;
  switch (command.type) {
    case "SharePoint":
    case "SharePoint_SelfIssued":
      authParams = { scopes: [ `${combine(command.resource, '.default')}` ] };
      break;
    default:
      return null;
  }
  try {
    const silent = await app.acquireTokenSilent(authParams);
    return silent.accessToken;
  } catch (e) {}
  try {
    const login = await app.loginPopup(authParams);
    if (login.account) app.setActiveAccount(login.account);
    const result = await app.acquireTokenSilent(authParams);
    return result.accessToken;
  } catch (e) {
    console.error('Token error:', e);
    return null;
  }
}
// ===== END AUTH.JS =====
  </script>
  <script type="text/javascript">
const baseUrl = "https://akcenta.sharepoint.com";
const params = {
  sdk: "8.0",
  entry: { oneDrive: { files: {} } },
  authentication: {},
  messaging: { origin: window.location.origin, channelId: "27" },
  typesAndSources: { mode: "files", pivots: { oneDrive: true, recent: true } },
};
let win = null;
let port = null;
async function launchPicker(e) {
  e.preventDefault();
  win = window.open("", "Picker", "width=800,height=600");
  const authToken = await getToken({ resource: baseUrl, command: "authenticate", type: "SharePoint" });
  const queryString = new URLSearchParams({ filePicker: JSON.stringify(params) });
  const url = baseUrl + `/_layouts/15/FilePicker.aspx?${queryString}`;
  const form = win.document.createElement("form");
  form.method = "POST";
  form.action = url;
  win.document.body.append(form);
  const input = win.document.createElement("input");
  input.type = "hidden";
  input.name = "access_token";
  input.value = authToken;
  form.appendChild(input);
  form.submit();
  window.addEventListener("message", (event) => {
    if (event.source && event.source === win) {
      const message = event.data;
      if (message.type === "initialize" && message.channelId === params.messaging.channelId) {
        port = event.ports[0];
        port.addEventListener("message", messageListener);
        port.start();
        port.postMessage({ type: "activate" });
      }
    }
  });
}
async function messageListener(event) {
  const msg = event.data;
  if (msg.type === "command") {
    const command = msg.data;
    switch (command.command) {
      case "pick":
        document.getElementById("pickedFiles").innerHTML = `<pre>${JSON.stringify(command, null, 2)}</pre>`;
        port.postMessage({ type: "result", id: msg.id, data: { result: "success" }});
        win.close();
        break;
      case "authenticate":
        const token = await getToken(command);
        port.postMessage({ type: "result", id: msg.id, data: { result: "token", token }});
        break;
    }
  }
}
  </script>
</head>
<body>
  <h1>OneDrive Picker v8 â€“ merged</h1>
  <button id="launchPicker">Launch Picker</button>
  <div id="pickedFiles"></div>
  <script>document.getElementById('launchPicker').onclick = launchPicker;</script>
</body>
</html>